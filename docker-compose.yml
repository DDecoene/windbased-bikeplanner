services:
  caddy:
    image: caddy:2-alpine
    ports:
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./certs:/etc/caddy/certs:ro
    depends_on:
      - frontend
      - backend
    mem_limit: 128m
    cpus: 0.25
    restart: unless-stopped

  backend:
    build: .
    volumes:
      - overpass_cache:/app/overpass_cache
      - analytics_data:/app/analytics_data
      - graph_data:/app/graph_data
    env_file:
      - .env
    mem_limit: 1536m
    cpus: 1.0
    restart: unless-stopped

  frontend:
    build:
      context: ./ui
      args:
        - PUBLIC_CLERK_PUBLISHABLE_KEY=${PUBLIC_CLERK_PUBLISHABLE_KEY}
    environment:
      - PUBLIC_CLERK_PUBLISHABLE_KEY=${PUBLIC_CLERK_PUBLISHABLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
    env_file:
      - .env
    depends_on:
      - backend
    mem_limit: 256m
    cpus: 0.5
    restart: unless-stopped

  watchdog:
    image: alpine/curl:8.11.1
    entrypoint: ["/bin/sh", "/watchdog.sh"]
    volumes:
      - ./watchdog.sh:/watchdog.sh:ro
    env_file:
      - .env
    depends_on:
      - backend
      - frontend
    mem_limit: 64m
    cpus: 0.25
    restart: unless-stopped

  claude:
    build:
      context: .
      dockerfile: Dockerfile.claude
    volumes:
      - .:/app
      - ~/.claude:/home/claude/.claude
    mem_limit: 1g
    cpus: 1.0
    stdin_open: true
    tty: true
    profiles:
      - claude

volumes:
  overpass_cache:
  analytics_data:
  graph_data:
